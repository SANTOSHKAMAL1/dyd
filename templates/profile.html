{% extends "base.html" %}

{% block title %}My Profile - Jain University{% endblock %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .profile-wrapper {
        max-width: 1200px;
        margin: 0 auto;
    }

    .profile-header-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        margin-bottom: 20px;
        text-align: center;
    }

    .user-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 50px;
        margin: 0 auto 20px;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .profile-header-card h1 {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .profile-header-card p {
        color: #666;
        font-size: 1.1em;
    }

    .tabs-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 12px 25px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1em;
        transition: all 0.3s ease;
        color: #333;
    }

    .tab-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .tab-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .tab-content {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .tab-content.active {
        display: block;
    }

    .form-section {
        margin-bottom: 30px;
    }

    .form-section h3 {
        color: #667eea;
        font-size: 1.3em;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 10px;
        color: #333;
        font-weight: 600;
        font-size: 1.05em;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .semester-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 12px;
        margin-top: 15px;
    }

    .semester-btn {
        padding: 15px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95em;
        transition: all 0.3s ease;
        text-align: center;
    }

    .semester-btn:hover {
        border-color: #667eea;
        background-color: #f0f4ff;
        transform: translateY(-2px);
    }

    .semester-btn.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .info-box {
        background-color: #f0f4ff;
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        color: #444;
        font-size: 0.95em;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .stat-label {
        font-size: 0.95em;
        opacity: 0.9;
    }

    .playlist-item {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .playlist-item:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }

    .course-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .course-code {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
    }

    .course-title {
        font-size: 1.15em;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .course-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 12px;
        font-size: 0.9em;
        color: #666;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
    }

    .meta-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 3px;
    }

    .badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        margin-right: 8px;
        margin-bottom: 8px;
    }

    .badge-semester {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .badge-level {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }

    .badge-credits {
        background-color: #e8f5e9;
        color: #388e3c;
    }

    .riasec-scores {
        background: #fff9e6;
        padding: 15px;
        border-radius: 8px;
        margin-top: 12px;
        border-left: 4px solid #ffc107;
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.9em;
    }

    .score-bar {
        flex: 1;
        background: #e0e0e0;
        height: 6px;
        border-radius: 3px;
        margin: 0 10px;
        overflow: hidden;
    }

    .score-fill {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: 13px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background-color: #e0e0e0;
        color: #333;
    }

    .btn-secondary:hover {
        background-color: #d0d0d0;
    }

    .no-items {
        text-align: center;
        padding: 40px;
        background: #f9f9f9;
        border-radius: 10px;
        color: #999;
    }

    .semester-playlist-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 10px;
    }

    .semester-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .semester-count {
        background: #667eea;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .profile-wrapper {
            margin: 10px;
        }

        .profile-header-card h1 {
            font-size: 1.8em;
        }

        .semester-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .button-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .course-meta {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="profile-wrapper">
    <!-- Header Card with User Info -->
    <div class="profile-header-card">
        <div class="user-avatar">üë§</div>
        <h1>{{ (profile_data.get('display_name') if profile_data else username) or username }}</h1>
        <p>Jain University Student</p>
        <p style="font-size: 0.95em; color: #999; margin-top: 10px;">
            üìß {{ (profile_data.get('email') if profile_data else 'Not set') or 'Not set' }}
        </p>
    </div>

    <!-- Alert Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tabs Navigation -->
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab(event, 'profile')">
            üë§ My Profile
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'semester')">
            üìÖ Semester Planning
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'playlist')">
            üìö My Playlist ({{ (playlist_data|length if playlist_data else 0) }})
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'marks')">
            üìä Academic Marks
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'riasec')">
            üéØ Career Match
        </button>
    </div>

    <!-- TAB 1: PROFILE SETTINGS -->
    <div id="profile" class="tab-content active">
        <h2 style="color: #667eea; margin-bottom: 20px;">üë§ My Profile</h2>
        
        <form method="POST" action="{{ url_for('update_profile') }}">
            <!-- Display Name -->
            <div class="form-section">
                <h3>‚úèÔ∏è Name & Contact</h3>
                <div class="form-group">
                    <label for="display_name">Your Name *</label>
                    <input 
                        type="text" 
                        id="display_name" 
                        name="display_name"
                        value="{{ (profile_data.get('display_name') if profile_data else username) or '' }}"
                        placeholder="Enter your full name"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email"
                        value="{{ (profile_data.get('email') if profile_data else '') or '' }}"
                        placeholder="your.email@jainuniversity.ac.in"
                    >
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone"
                        value="{{ (profile_data.get('phone') if profile_data else '') or '' }}"
                        placeholder="+91-XXXXXXXXXX"
                    >
                </div>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input 
                        type="text" 
                        id="location" 
                        name="location"
                        value="{{ (profile_data.get('location') if profile_data else '') or '' }}"
                        placeholder="City, State"
                    >
                </div>
            </div>

            <!-- Bio -->
            <div class="form-section">
                <h3>üìù About You</h3>
                <div class="form-group">
                    <label for="bio">Bio / About Yourself</label>
                    <textarea 
                        id="bio" 
                        name="bio"
                        placeholder="Tell us about your academic interests and career goals..."
                        style="resize: vertical; min-height: 100px;"
                    >{{ (profile_data.get('bio') if profile_data else '') or '' }}</textarea>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">üö™ Logout</a>
            </div>
        </form>
    </div>

    <!-- TAB 2: SEMESTER PLANNING -->
    <div id="semester" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;">üìÖ Semester Planning</h2>
        
        <div class="info-box">
            <strong>üéì Select Your Current Semester:</strong> This helps us recommend courses appropriate for your level.
        </div>

        <form method="POST" action="{{ url_for('update_profile') }}">
            <div class="form-section">
                <h3>Choose Your Semester</h3>
                
                <div class="semester-grid">
                    {% for sem in [1, 2, 3, 4, 5, 6, 7, 8] %}
                        <button 
                            type="button"
                            class="semester-btn {% if profile_data and profile_data.get('current_semester', 1) == sem %}selected{% endif %}"
                            onclick="selectSemester({{ sem }}, event)"
                            data-semester="{{ sem }}"
                        >
                            Sem {{ sem }}
                        </button>
                    {% endfor %}
                </div>
                
                <input 
                    type="hidden" 
                    id="current_semester" 
                    name="current_semester"
                    value="{{ (profile_data.get('current_semester') if profile_data else 1) or 1 }}"
                >
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary">üíæ Save Semester</button>
            </div>
        </form>
    </div>

    <!-- TAB 3: MY PLAYLIST - ORGANIZED BY SEMESTER -->
    <div id="playlist" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;">üìö My Course Playlist</h2>
        
        <div class="info-box">
            <strong>üéØ Your Playlist by Semester:</strong> All courses organized by semester.
        </div>

        {% if playlist_data and playlist_data|length > 0 %}
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ playlist_data|length }}</div>
                    <div class="stat-label">Total Courses</div>
                </div>
                {% set total_credits = 0 %}
                {% for course in playlist_data %}
                    {% set total_credits = total_credits + (course.get('credits', 0)|int) %}
                {% endfor %}
                <div class="stat-card">
                    <div class="stat-number">{{ total_credits }}</div>
                    <div class="stat-label">Total Credits</div>
                </div>
            </div>

            <!-- Organize courses by semester -->
            {% set semesters = {} %}
            {% for course in playlist_data %}
                {% set sem = (course.get('recommended_semester') if course else 'N/A')|int %}
                {% if sem not in semesters %}
                    {% set _ = semesters.update({sem: []}) %}
                {% endif %}
                {% set _ = semesters[sem].append(course) %}
            {% endfor %}

            <!-- Display courses organized by semester -->
            {% for sem in [1, 2, 3, 4, 5, 6, 7, 8] %}
                {% if sem in semesters and semesters[sem]|length > 0 %}
                    <div class="semester-playlist-section">
                        <div class="semester-title">
                            üìö Semester {{ sem }}
                            <span class="semester-count">{{ semesters[sem]|length }} course{{ 's' if semesters[sem]|length != 1 else '' }}</span>
                        </div>

                        {% for course in semesters[sem] %}
                            <div class="playlist-item">
                                <div class="course-header">
                                    <div>
                                        <span class="course-code">{{ (course.get('course_code') if course else 'N/A') or 'N/A' }}</span>
                                    </div>
                                </div>

                                <div class="course-title">{{ (course.get('course_title') if course else 'No Title') or 'No Title' }}</div>

                                <div class="course-meta">
                                    <div class="meta-item">
                                        <span class="meta-label">üìÖ Semester:</span>
                                        <span class="badge badge-semester">Sem {{ (course.get('recommended_semester') if course else 'N/A') or 'N/A' }}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">üéì Level:</span>
                                        <span class="badge badge-level">{{ (course.get('level') if course else 'Beginner') or 'Beginner' }}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">üìö Credits:</span>
                                        <span class="badge badge-credits">{{ (course.get('credits') if course else 'N/A') or 'N/A' }}</span>
                                    </div>
                                </div>

                                <div style="margin-top: 12px; font-size: 0.9em; color: #666;">
                                    <strong>üìù Description:</strong> {{ ((course.get('description') if course else 'N/A') or 'N/A')[:200] }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}

        {% else %}
            <div class="no-items">
                <p>üì≠ Your playlist is empty!</p>
                <p style="margin-top: 15px; font-size: 0.95em;">
                    Go to the <strong><a href="{{ url_for('assistant') }}" style="color: #667eea; text-decoration: underline;">AI Assistant ‚Üí</a></strong> to search for courses and add them to your playlist.
                </p>
            </div>
        {% endif %}
    </div>

    <!-- TAB 4: ACADEMIC MARKS -->
    <div id="marks" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;">üìä Academic Marks</h2>
        
        {% if marks_data and marks_data|length > 0 %}
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ marks_data|length }}</div>
                    <div class="stat-label">Subjects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ "%.1f"|format((marks_data|map(attribute='percentage')|sum) / (marks_data|length)) }}%</div>
                    <div class="stat-label">Average Score</div>
                </div>
            </div>

            {% for mark in marks_data %}
            <div class="playlist-item">
                <div class="course-header">
                    <div>
                        <span class="course-title">{{ mark.subject if mark else 'N/A' }}</span>
                    </div>
                    <div style="text-align: right;">
                        <strong style="font-size: 1.3em; color: #667eea;">{{ "%.1f"|format(mark.percentage if mark else 0) }}%</strong>
                    </div>
                </div>
                
                <div style="margin-top: 12px; width: 100%; background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
                    <div style="width: {{ mark.percentage if mark else 0 }}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%;"></div>
                </div>
            </div>
            {% endfor %}

        {% else %}
            <div class="no-items">
                <p>üì≠ No marks entered yet</p>
                <p style="margin-top: 10px;">
                    <a href="{{ url_for('marks') }}" style="color: #667eea; text-decoration: underline; font-weight: 600;">
                        Add your academic marks ‚Üí
                    </a>
                </p>
            </div>
        {% endif %}
    </div>

    <!-- TAB 5: RIASEC & CAREER MATCH -->
    <div id="riasec" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;">üéØ Career Personality Match</h2>
        
        {% if riasec_data and riasec_data.get('scores') %}
            <div class="info-box">
                <strong>üéØ Your Career Profile:</strong> Based on your RIASEC assessment, here's your personality type.
            </div>

            <!-- Complete Scores -->
            <div class="form-section">
                <h3>Complete RIASEC Scores</h3>
                
                {% set trait_list = ['R', 'I', 'A', 'S', 'E', 'C'] %}
                {% set trait_names = {'R': 'Realistic', 'I': 'Investigative', 'A': 'Artistic', 'S': 'Social', 'E': 'Enterprising', 'C': 'Conventional'} %}
                
                {% for trait in trait_list %}
                    {% set score = riasec_data.get('scores', {}).get(trait, 0) if riasec_data else 0 %}
                    <div class="playlist-item">
                        <div class="course-header">
                            <div>
                                <span class="course-code">{{ trait }}</span>
                                <span class="course-title">{{ trait_names.get(trait, 'Unknown') }}</span>
                            </div>
                            <div style="text-align: right;">
                                <strong style="font-size: 1.2em; color: #667eea;">{{ "%.1f"|format(score * 100) }}%</strong>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; width: 100%;">
                            <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="width: {{ score * 100 }}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <div class="no-items">
                <p>üéØ RIASEC Assessment Pending</p>
                <p style="margin-top: 10px;">
                    <a href="{{ url_for('survey') }}" style="color: #667eea; text-decoration: underline; font-weight: 600;">
                        Take the RIASEC Career Assessment ‚Üí
                    </a>
                </p>
            </div>
        {% endif %}
    </div>

</div>

<script>
// Tab switching
function switchTab(event, tabName) {
    event.preventDefault();
    
    // Hide all tabs
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Remove active from all buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// Semester selection
function selectSemester(semester, event) {
    event.preventDefault();
    document.getElementById('current_semester').value = semester;
    document.querySelectorAll('.semester-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    event.target.classList.add('selected');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Set selected semester button
    const currentSem = document.getElementById('current_semester').value || '1';
    document.querySelectorAll('.semester-btn').forEach(btn => {
        if (btn.getAttribute('data-semester') === currentSem) {
            btn.classList.add('selected');
        }
    });
});
</script>
{% endblock %}