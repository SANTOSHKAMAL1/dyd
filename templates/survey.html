{% extends "base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIASEC Assessment - Jain University</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f1f1f1 0%, #f6f5f7 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .survey-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 2rem auto;
            max-width: 800px;
        }
        
        .survey-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .survey-body {
            padding: 2rem;
        }
        
        .question-card {
            background: #f8f9fa;
            border: none;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
        }
        
        .btn-answer {
            width: 48%;
            margin: 0.5rem 1%;
            padding: 1rem 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-answer:hover {
            border-color: #3498db;
            background: #f8f9fa;
            transform: translateY(-1px);
        }
        
        .btn-answer.selected {
            border-color: #3498db;
            background: #3498db;
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-yes.selected {
            border-color: #2ecc71;
            background: #2ecc71;
        }
        
        .btn-no.selected {
            border-color: #e74c3c;
            background: #e74c3c;
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.5s ease;
        }
        
        .welcome-screen, .questions-screen, .results-screen {
            display: none;
        }
        
        .welcome-screen.active, .questions-screen.active, .results-screen.active {
            display: block;
        }
        
        .trait-badge {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin: 0.25rem;
        }
        
        .career-list {
            list-style: none;
            padding: 0;
        }
        
        .career-list li {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-outline-primary {
            border: 2px solid #3498db;
            color: #3498db;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .assessment-info {
            background: #e8f4fc;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .info-icon {
            color: #3498db;
            margin-right: 0.5rem;
        }
        
        .answer-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Survey Container -->
    <div class="container">
        <div class="survey-container">
            
            <!-- Welcome Screen -->
            <div class="welcome-screen active" id="welcomeScreen">
                <div class="survey-header">
                    <h1><i class="fas fa-clipboard-check me-2"></i>RIASEC Career Assessment</h1>
                    <p class="lead mb-0">Discover your personality type and ideal career paths</p>
                </div>
                <div class="survey-body">
                    <!-- Returning User Notification -->
                    {% if riasec_data %}
                    <div class="alert alert-info">
                        <h4><i class="fas fa-info-circle me-2"></i>Welcome Back!</h4>
                        <p class="mb-2">You have already completed this assessment.</p>
                        <p class="mb-0">
                            <strong>Your previous results:</strong> 
                            {% for trait in riasec_data.top3 %}
                            <span class="trait-badge">{{ get_trait_name(trait) }}</span>
                            {% endfor %}
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="assessment-info">
                        <h4><i class="fas fa-info-circle info-icon"></i>About This Assessment</h4>
                        <p>The RIASEC model helps identify your interests across six personality types:</p>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>R - Realistic:</strong> Practical, hands-on, technical</p>
                                <p><strong>I - Investigative:</strong> Analytical, scientific, curious</p>
                                <p><strong>A - Artistic:</strong> Creative, expressive, original</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>S - Social:</strong> Helpful, teaching, cooperative</p>
                                <p><strong>E - Enterprising:</strong> Persuasive, leadership, ambitious</p>
                                <p><strong>C - Conventional:</strong> Organized, detail-oriented, systematic</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <h4>What to Expect</h4>
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <div class="result-card text-center">
                                    <i class="fas fa-list-ol fa-2x text-primary mb-2"></i>
                                    <h6>42 Questions</h6>
                                    <small>Simple Yes/No answers</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="result-card text-center">
                                    <i class="fas fa-chart-pie fa-2x text-success mb-2"></i>
                                    <h6>Personality Analysis</h6>
                                    <small>Discover your top 3 traits</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="result-card text-center">
                                    <i class="fas fa-briefcase fa-2x text-warning mb-2"></i>
                                    <h6>Career Matches</h6>
                                    <small>Get personalized recommendations</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-center gap-3">
                            {% if riasec_data %}
                            <button class="btn btn-outline-primary btn-lg" onclick="viewPreviousResults()">
                                <i class="fas fa-chart-bar me-2"></i>View Previous Results
                            </button>
                            {% endif %}
                            <button class="btn btn-primary btn-lg" onclick="startSurvey()">
                                <i class="fas fa-play me-2"></i>
                                {% if riasec_data %}Retake Assessment{% else %}Start Assessment{% endif %}
                            </button>
                        </div>
                        
                        {% if riasec_data %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Retaking the assessment will overwrite your previous results
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Questions Screen -->
            <div class="questions-screen" id="questionsScreen">
                <div class="survey-header">
                    <h2>Career Interest Assessment</h2>
                    <p id="questionNumber" class="mb-0">Question 1 of 42</p>
                </div>
                <div class="survey-body">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="question-card">
                        <h4 id="questionText" class="mb-4 text-center">Loading question...</h4>
                        
                        <div class="answer-options">
                            <button class="btn btn-answer btn-yes" onclick="answerQuestion(1)">
                                <i class="fas fa-check me-2"></i>Yes
                            </button>
                            <button class="btn btn-answer btn-no" onclick="answerQuestion(0)">
                                <i class="fas fa-times me-2"></i>No
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Answer honestly based on your genuine interests and preferences
                        </small>
                    </div>
                </div>
            </div>

            <!-- Results Screen -->
            <div class="results-screen" id="resultsScreen">
                <div class="survey-header">
                    <h1><i class="fas fa-chart-line me-2"></i>Assessment Complete!</h1>
                    <p class="mb-0">Your personalized career analysis is ready</p>
                </div>
                <div class="survey-body">
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Analyzing your results and generating career recommendations...</p>
                    </div>
                    
                    <div id="resultsContent" style="display: none;">
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle me-2"></i>Thank you for completing the assessment!</h4>
                            <p class="mb-0">Your results have been saved and you'll be redirected to your dashboard shortly.</p>
                        </div>
                        
                        <div class="text-center">
                            <div class="spinner-border text-primary mt-3" role="status">
                                <span class="visually-hidden">Redirecting...</span>
                            </div>
                            <p class="mt-2">Redirecting to dashboard in 3 seconds...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // All 42 RIASEC Questions with their trait codes
        const RIASEC_QUESTIONS = [
            { text: "I like to work on cars", trait: "R" },
            { text: "I like to build things", trait: "R" },
            { text: "I like putting things together or assembling things.", trait: "R" },
            { text: "I like to take care of animals", trait: "R" },
            { text: "I like to cook", trait: "R" },
            { text: "I am a practical person", trait: "R" },
            { text: "I like working outdoors", trait: "R" },
            { text: "I like working with numbers or charts", trait: "I" },
            { text: "I'm good at math", trait: "I" },
            { text: "I enjoy trying to figure out how things work", trait: "I" },
            { text: "I like to analyze things (problems/situations)", trait: "I" },
            { text: "I like to do puzzles", trait: "I" },
            { text: "I enjoy science", trait: "I" },
            { text: "I like to do experiments", trait: "I" },
            { text: "I like to teach or train people", trait: "S" },
            { text: "I like to play instruments or sing", trait: "A" },
            { text: "I like to read about art and music", trait: "A" },
            { text: "I like to draw", trait: "A" },
            { text: "I enjoy creative writing", trait: "A" },
            { text: "I am a creative person", trait: "A" },
            { text: "I like acting in plays", trait: "A" },
            { text: "I like helping people", trait: "S" },
            { text: "I like to get into discussions about issues", trait: "S" },
            { text: "I enjoy learning about other cultures", trait: "S" },
            { text: "I am interested in healing people", trait: "S" },
            { text: "I like trying to help people solve their problems", trait: "S" },
            { text: "I like to work in teams", trait: "S" },
            { text: "I am an ambitious person, I set goals for myself", trait: "E" },
            { text: "I would like to start my own business", trait: "E" },
            { text: "I am quick to take on new responsibilities", trait: "E" },
            { text: "I like selling things", trait: "E" },
            { text: "I like to lead", trait: "E" },
            { text: "I like to try to influence or persuade people", trait: "E" },
            { text: "I like to give speeches", trait: "E" },
            { text: "I like to organize things, (files, desks/offices)", trait: "C" },
            { text: "I like to have clear instructions to follow", trait: "C" },
            { text: "I wouldn't mind working 8 hours per day in an office", trait: "C" },
            { text: "I pay attention to details", trait: "C" },
            { text: "I like to do filing or typing", trait: "C" },
            { text: "I am good at keeping records of my work", trait: "C" },
            { text: "I would like to work in an office", trait: "C" }
        ];

        let currentQuestion = 0;
        let answers = {};

        // Initialize answers object
        RIASEC_QUESTIONS.forEach((q) => {
            answers[q.text] = null;
        });

        function startSurvey() {
            document.getElementById('welcomeScreen').classList.remove('active');
            document.getElementById('questionsScreen').classList.add('active');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestion >= RIASEC_QUESTIONS.length) {
                showResults();
                return;
            }

            const question = RIASEC_QUESTIONS[currentQuestion];
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1} of ${RIASEC_QUESTIONS.length}`;
            document.getElementById('questionText').textContent = question.text;
            
            // Update progress bar
            const progress = ((currentQuestion) / RIASEC_QUESTIONS.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Clear previous selection
            document.querySelectorAll('.btn-answer').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function answerQuestion(answer) {
            const question = RIASEC_QUESTIONS[currentQuestion];
            answers[question.text] = answer;
            
            // Visual feedback for selection
            const buttons = document.querySelectorAll('.btn-answer');
            buttons.forEach((btn, index) => {
                if ((index === 0 && answer === 1) || (index === 1 && answer === 0)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            // Move to next question after a brief delay
            setTimeout(() => {
                currentQuestion++;
                if (currentQuestion < RIASEC_QUESTIONS.length) {
                    showQuestion();
                } else {
                    showResults();
                }
            }, 500);
        }

        function showResults() {
            document.getElementById('questionsScreen').classList.remove('active');
            document.getElementById('resultsScreen').classList.add('active');
            
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            
            // Submit results to server
            submitResults();
        }

       async function submitResults() {
    try {
        // Debug: Check what's being sent
        console.log("Submitting answers:", answers);
        console.log("Answers count:", Object.keys(answers).length);
        
        // Check for unanswered questions
        const unanswered = RIASEC_QUESTIONS.filter(q => answers[q.text] === null);
        console.log("Unanswered questions:", unanswered.length);
        
        if (unanswered.length > 0) {
            console.log("Some questions unanswered, filling with 0");
            unanswered.forEach(q => {
                answers[q.text] = 0;
            });
        }

        // Prepare data for submission
        const submissionData = {
            answers: answers
        };

        console.log("Sending data to server...");
        const response = await fetch('/survey', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(submissionData)
        });

        console.log("Response status:", response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log("Server response:", result);
            
            if (result.success) {
                // Show success message
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('resultsContent').style.display = 'block';
                
                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 3000);
            } else {
                showError('Failed to save results: ' + (result.message || 'Unknown error'));
            }
        } else {
            const errorText = await response.text();
            console.error("Server error response:", errorText);
            showError('Server error: ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Error submitting survey results:', error);
        showError('Network error: ' + error.message);
    }
}

        function showError(message) {
            const resultsScreen = document.getElementById('resultsScreen');
            resultsScreen.innerHTML = `
                <div class="survey-header">
                    <h2><i class="fas fa-exclamation-triangle me-2"></i>Error</h2>
                </div>
                <div class="survey-body text-center">
                    <div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-triangle me-2"></i>Oops! Something went wrong</h4>
                        <p>${message}</p>
                    </div>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-primary" onclick="retakeSurvey()">
                            <i class="fas fa-redo me-2"></i>Try Again
                        </button>
                        <button class="btn btn-primary" onclick="goToDashboard()">
                            <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                        </button>
                    </div>
                </div>
            `;
        }

        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        function viewPreviousResults() {
            window.location.href = '/riasec/results';
        }

        function retakeSurvey() {
            // Force page reload to reset everything completely
            window.location.reload();
        }

        // Keyboard navigation for Yes/No
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('questionsScreen').classList.contains('active')) {
                if (event.key === 'y' || event.key === 'Y' || event.key === '1') {
                    answerQuestion(1); // Yes
                } else if (event.key === 'n' || event.key === 'N' || event.key === '0') {
                    answerQuestion(0); // No
                }
            }
        });

        // Initialize answer buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.btn-answer');
            buttons.forEach((button, index) => {
                button.addEventListener('click', function() {
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% endblock %}